{
  "pluginType": "DB",
  "pluginId": "postgres-plugin",
  "unpublishedAction": {
    "name": "MTD_vs_New_videos_views",
    "datasource": {
      "pluginId": "postgres-plugin",
      "messages": [],
      "isAutoGenerated": false,
      "id": "Fb_video_dashboard_datasrc",
      "deleted": false,
      "policies": [],
      "userPermissions": []
    },
    "pageId": "Facebook",
    "actionConfiguration": {
      "timeoutInMillisecond": 10000,
      "paginationType": "NONE",
      "encodeParamsToggle": true,
      "body": "with CTE_MTD_Start as (\n    select name, view_date, \n\tcount(Distinct(video_id)) as count_site,\n\tsum(total_video_views::decimal) as total_video_views\n    FROM public.smg_dmp_fb_video_dashboard_unq_view\n    where name is not null and view_date = '{{moment().format(\"YYYY-MM-01 00:00:00\")}}':: date\n\tAND created_time >= '{{moment().format(\"YYYY-MM-01 00:00:00\")}}'\n  AND created_time <= '{{moment().add(-1, 'day').format(\"YYYY-MM-DD 23:59:59\")}}'\n    group by 1,2\n),\nCTE_MTD_End as (\n    select name, view_date,\n\tcount(Distinct(video_id)) as count_site,\n\tsum(total_video_views::decimal) as total_video_views\n    FROM public.smg_dmp_fb_video_dashboard_unq_view\n    where name is not null \n\tand view_date ='{{moment().add(-1, 'day').format(\"YYYY-MM-DD 23:59:59\")}}':: date\n\tAND created_time >= '{{moment().format(\"YYYY-MM-01 00:00:00\")}}'\n  AND created_time <= '{{moment().add(-1, 'day').format(\"YYYY-MM-DD 23:59:59\")}}'\n    group by 1,2\n),\nCTE_LastMonth_Start as (\n  select name, view_date,\n\tsum(total_video_views::decimal) as total_video_views\n    FROM public.smg_dmp_fb_video_dashboard_unq_view\n    where name is not null and view_date = '{{moment().add(-1,\"month\").format(\"YYYY-MM-01\")}}':: date\n\tAND created_time >= '{{moment().add(-1,\"month\").format(\"YYYY-MM-01\")}}'\n  AND created_time <= '{{moment().add(-1,\"month\").format(\"YYYY-MM-30\")}}'\n    group by 1,2\n),\nCTE_LastMonth_End as (\n    select name, view_date, sum(total_video_views::decimal) as total_video_views\n    FROM public.smg_dmp_fb_video_dashboard_unq_view\n    where name is not null and view_date = '{{moment().add(-1,\"month\").format(\"YYYY-MM-30\")}}':: date\n\tAND created_time >= '{{moment().add(-1,\"month\").format(\"YYYY-MM-01\")}}'\n  AND created_time <= '{{moment().add(-1,\"month\").format(\"YYYY-MM-30\")}}'\n    group by 1,2\n),\nCTE_LastYearMonth_Start as (\n    select name, view_date, sum(total_video_views::decimal) as total_video_views\n    FROM public.smg_dmp_fb_video_dashboard_unq_view\n    where name is not null and view_date = '{{moment().add(-1,\"month\").format(\"YYYY-MM-01\")}}':: date\n\tAND created_time >= '{{moment().add(-1,\"year\").format(\"YYYY-MM-01\")}}'\n  AND created_time <= '{{moment().add(-1,\"year\").format(\"YYYY-MM-DD\")}}'\n    group by 1,2\n),\nCTE_LastYearMonth_End as (\n    select name, view_date, sum(total_video_views::decimal) as total_video_views\n    FROM public.smg_dmp_fb_video_dashboard_unq_view\n    where name is not null and view_date = '{{moment().add(-1,\"year\").format(\"YYYY-MM-DD\")}}':: date\n\tAND created_time >= '{{moment().add(-1,\"year\").format(\"YYYY-MM-01\")}}'\n  AND created_time <= '{{moment().add(-1,\"year\").format(\"YYYY-MM-DD\")}}'\n    group by 1,2\n)\nselect channel,cnt,\ntrunc(mtd,0) as mtd, \nconcat(trunc((mtd-mtd_lastMonth)*100/NULLIF(mtd_lastMonth,0),2),'%') as mtd_lastMonth_perc,\nconcat(trunc((mtd-mtd_lastYearMonth)*100/NULLIF(mtd_lastYearMonth,0),2),'%') as mtd_lastYear_perc\nfrom(\nselect coalesce(CTE_MTD_Start.name,CTE_MTD_End.name,CTE_LastMonth_Start.name,CTE_LastMonth_End.name,CTE_LastYearMonth_Start.name,CTE_LastYearMonth_End.name) as channel,\nCTE_MTD_End.count_site as cnt,\nSUM(coalesce(CTE_MTD_End.total_video_views,0)-coalesce(CTE_MTD_Start.total_video_views,0)) as mtd,\nSUM(coalesce(CTE_LastMonth_End.total_video_views,0)-coalesce(CTE_LastMonth_Start.total_video_views,0)) as mtd_lastMonth,\nSUM(coalesce(CTE_LastYearMonth_End.total_video_views,0)-coalesce(CTE_LastYearMonth_Start.total_video_views,0)) as mtd_lastYearMonth\nfrom CTE_MTD_Start \nFULL OUTER JOIN CTE_MTD_End on CTE_MTD_Start.name = CTE_MTD_End.name\nFULL OUTER JOIN CTE_LastMonth_Start on CTE_LastMonth_Start.name = CTE_MTD_End.name\nFULL OUTER JOIN CTE_LastMonth_End on CTE_LastMonth_End.name = CTE_LastMonth_Start.name\nFULL OUTER JOIN CTE_LastYearMonth_Start on CTE_LastYearMonth_Start.name = CTE_LastMonth_End.name\nFULL OUTER JOIN CTE_LastYearMonth_End on CTE_LastYearMonth_End.name = CTE_LastMonth_End.name\n\twhere CTE_MTD_End.count_site is not null\ngroup by 1,2 order by 1\n) as main\n\nUNION ALL\n\nselect channel,cnt,\ntrunc(mtd,0) as mtd,  \nconcat(trunc((mtd-mtd_lastMonth)*100/NULLIF(mtd_lastMonth,0),2),'%') as mtd_lastMonth_perc,\nconcat(trunc((mtd-mtd_lastYearMonth)*100/NULLIF(mtd_lastYearMonth,0),2),'%') as mtd_lastYear_perc\nfrom(\nselect 'Total' as channel,\nSUM(CTE_MTD_End.count_site) as cnt,\nSUM(coalesce(CTE_MTD_End.total_video_views,0)-coalesce(CTE_MTD_Start.total_video_views,0)) as mtd,\nSUM(coalesce(CTE_LastMonth_End.total_video_views,0)-coalesce(CTE_LastMonth_Start.total_video_views,0)) as mtd_lastMonth,\nSUM(coalesce(CTE_LastYearMonth_End.total_video_views,0)-coalesce(CTE_LastYearMonth_Start.total_video_views,0)) as mtd_lastYearMonth\nfrom CTE_MTD_Start \nFULL OUTER JOIN CTE_MTD_End on CTE_MTD_Start.name = CTE_MTD_End.name\nFULL OUTER JOIN CTE_LastMonth_Start on CTE_LastMonth_Start.name = CTE_MTD_End.name\nFULL OUTER JOIN CTE_LastMonth_End on CTE_LastMonth_End.name = CTE_LastMonth_Start.name\nFULL OUTER JOIN CTE_LastYearMonth_Start on CTE_LastYearMonth_Start.name = CTE_LastMonth_End.name\nFULL OUTER JOIN CTE_LastYearMonth_End on CTE_LastYearMonth_End.name = CTE_LastMonth_End.name\n) as total;"
    },
    "executeOnLoad": true,
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "isValid": true,
    "invalids": [],
    "messages": [],
    "jsonPathKeys": [
      "moment().add(-1, 'day').format(\"YYYY-MM-DD 23:59:59\")",
      "moment().add(-1,\"month\").format(\"YYYY-MM-01\")",
      "moment().add(-1,\"month\").format(\"YYYY-MM-30\")",
      "moment().add(-1,\"year\").format(\"YYYY-MM-01\")",
      "moment().add(-1,\"year\").format(\"YYYY-MM-DD\")",
      "moment().format(\"YYYY-MM-01 00:00:00\")"
    ],
    "userSetOnLoad": false,
    "confirmBeforeExecute": false,
    "policies": [],
    "userPermissions": []
  },
  "id": "Facebook_MTD_vs_New_videos_views",
  "deleted": false,
  "gitSyncId": "62837f843cd70e097b62341a_62b953344c1f4b56d4d33d7e"
}