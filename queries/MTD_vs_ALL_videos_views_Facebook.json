{
  "pluginType": "DB",
  "pluginId": "postgres-plugin",
  "unpublishedAction": {
    "name": "MTD_vs_ALL_videos_views",
    "datasource": {
      "pluginId": "postgres-plugin",
      "messages": [],
      "isAutoGenerated": false,
      "id": "Fb_video_dashboard_datasrc",
      "deleted": false,
      "policies": [],
      "userPermissions": []
    },
    "pageId": "Facebook",
    "actionConfiguration": {
      "timeoutInMillisecond": 20000,
      "paginationType": "NONE",
      "encodeParamsToggle": true,
      "body": "with CTE_MTD_Start as (\n    select name,video_id,view_date, sum(total_video_views::decimal) as total_video_views\n    FROM public.smg_dmp_fb_video_dashboard_unq_view\n    where name is not null and view_date = '{{moment().format(\"YYYY-MM-01\")}}':: date\n    group by 1,2,3\n),\nCTE_MTD_End as (\n    select name,video_id, view_date, sum(total_video_views::decimal) as total_video_views\n    FROM public.smg_dmp_fb_video_dashboard_unq_view\n    where name is not null and view_date = '{{moment().add(-1, 'day')}}':: date\n    group by 1,2,3\n),\nCTE_LastMonth_Start as (\n    select name,video_id, view_date, sum(total_video_views::decimal) as total_video_views\n    FROM public.smg_dmp_fb_video_dashboard_unq_view\n    where name is not null and view_date = '{{moment().add(-1,\"month\").format(\"YYYY-MM-01\")}}':: date\n    group by 1,2,3\n),\nCTE_LastMonth_End as (\n    select name,video_id, view_date, sum(total_video_views::decimal) as total_video_views\n    FROM public.smg_dmp_fb_video_dashboard_unq_view\n    where name is not null and view_date =date_trunc('month', now())::date - 1\n    group by 1,2,3\n),\nCTE_LastYearMonth_Start as (\n    select name, video_id, view_date, sum(total_video_views::decimal) as total_video_views\n    FROM public.smg_dmp_fb_video_dashboard_unq_view\n    where name is not null and view_date = '{{moment().add(-1,\"year\").format(\"YYYY-MM-01\")}}':: date\n    group by 1,2,3\n),\nCTE_LastYearMonth_End as (\n    select name, video_id, view_date, sum(total_video_views::decimal) as total_video_views\n    FROM public.smg_dmp_fb_video_dashboard_unq_view\n    where name is not null and view_date = '{{moment().add(-1,\"year\").add(-1,\"day\").format(\"YYYY-MM-DD\")}}':: date\n    group by 1,2,3\n)\nselect channel, \ntrunc(mtd,0) as mtd, \nconcat(trunc((mtd-mtd_lastMonth)*100/NULLIF(mtd_lastMonth,0),2),'%') as mtd_lastMonth_perc,\nconcat(trunc((mtd-mtd_lastYearMonth)*100/NULLIF(mtd_lastYearMonth,0),2),'%') as mtd_lastYear_perc\nfrom(\nselect coalesce(CTE_MTD_Start.name,CTE_MTD_End.name,CTE_LastMonth_Start.name,CTE_LastMonth_End.name,CTE_LastYearMonth_Start.name,CTE_LastYearMonth_End.name) as channel,\nSUM(CTE_MTD_End.total_video_views-coalesce(CTE_MTD_Start.total_video_views,0)) as mtd,\nSUM(CTE_LastMonth_End.total_video_views-coalesce(CTE_LastMonth_Start.total_video_views,0)) as mtd_lastMonth,\nSUM(CTE_LastYearMonth_End.total_video_views-coalesce(CTE_LastYearMonth_Start.total_video_views,0)) as mtd_lastYearMonth\nfrom CTE_MTD_Start \nFULL OUTER JOIN CTE_MTD_End on CTE_MTD_Start.video_id = CTE_MTD_End.video_id\nFULL OUTER JOIN CTE_LastMonth_Start on CTE_LastMonth_Start.video_id = CTE_MTD_End.video_id\nFULL OUTER JOIN CTE_LastMonth_End on CTE_LastMonth_End.video_id = CTE_LastMonth_Start.video_id\nFULL OUTER JOIN CTE_LastYearMonth_Start on CTE_LastYearMonth_Start.video_id = CTE_LastMonth_End.video_id\nFULL OUTER JOIN CTE_LastYearMonth_End on CTE_LastYearMonth_End.video_id = CTE_LastMonth_End.video_id\ngroup by 1 order by 1\n) as main\n\nUNION ALL\n\nselect channel,\ntrunc(mtd,0) as mtd,  \nconcat(trunc((mtd-mtd_lastMonth)*100/NULLIF(mtd_lastMonth,0),2),'%') as mtd_lastMonth_perc,\nconcat(trunc((mtd-mtd_lastYearMonth)*100/NULLIF(mtd_lastYearMonth,0),2),'%') as mtd_lastYear_perc\nfrom(\nselect 'Total' as channel,\nSUM(CTE_MTD_End.total_video_views-coalesce(CTE_MTD_Start.total_video_views,0)) as mtd,\nSUM(CTE_LastMonth_End.total_video_views-coalesce(CTE_LastMonth_Start.total_video_views,0)) as mtd_lastMonth,\nSUM(CTE_LastYearMonth_End.total_video_views-coalesce(CTE_LastYearMonth_Start.total_video_views,0)) as mtd_lastYearMonth\nfrom CTE_MTD_Start \nFULL OUTER JOIN CTE_MTD_End on CTE_MTD_Start.video_id = CTE_MTD_End.video_id\nFULL OUTER JOIN CTE_LastMonth_Start on CTE_LastMonth_Start.video_id = CTE_MTD_End.video_id\nFULL OUTER JOIN CTE_LastMonth_End on CTE_LastMonth_End.video_id = CTE_LastMonth_Start.video_id\nFULL OUTER JOIN CTE_LastYearMonth_Start on CTE_LastYearMonth_Start.video_id = CTE_LastMonth_End.video_id\nFULL OUTER JOIN CTE_LastYearMonth_End on CTE_LastYearMonth_End.video_id = CTE_LastMonth_End.video_id\n) as total;"
    },
    "executeOnLoad": true,
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "isValid": true,
    "invalids": [],
    "messages": [],
    "jsonPathKeys": [
      "moment().add(-1, 'day')",
      "moment().add(-1,\"month\").format(\"YYYY-MM-01\")",
      "moment().add(-1,\"year\").add(-1,\"day\").format(\"YYYY-MM-DD\")",
      "moment().add(-1,\"year\").format(\"YYYY-MM-01\")",
      "moment().format(\"YYYY-MM-01\")"
    ],
    "userSetOnLoad": false,
    "confirmBeforeExecute": false,
    "policies": [],
    "userPermissions": []
  },
  "id": "Facebook_MTD_vs_ALL_videos_views",
  "deleted": false,
  "gitSyncId": "62837f843cd70e097b62341a_62a9463f4c1f4b56d4d33d0a"
}