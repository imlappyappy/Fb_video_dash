{
  "pluginType": "DB",
  "pluginId": "postgres-plugin",
  "unpublishedAction": {
    "name": "MTD_vs_new_watchhrs",
    "datasource": {
      "pluginId": "postgres-plugin",
      "messages": [],
      "isAutoGenerated": false,
      "id": "Fb_video_dashboard_datasrc",
      "deleted": false,
      "policies": [],
      "userPermissions": []
    },
    "pageId": "Facebook",
    "actionConfiguration": {
      "timeoutInMillisecond": 15000,
      "paginationType": "NONE",
      "encodeParamsToggle": true,
      "body": "with CTE_MTD_Start as (\n    select name, view_date, \n\tcount(Distinct(video_id)) as count_site,\n\tsum(total_video_view_total_time::decimal) as total_video_view_total_time\n    FROM public.smg_dmp_fb_video_dashboard_unq_view\n    where name is not null and view_date = '2022-10-01'\n\tAND created_time >= '2022-10-01'\n  AND created_time <= '2022-10-12'\n    group by 1,2\n),\nCTE_MTD_End as (\n    select name, view_date,\n\tcount(Distinct(video_id)) as count_site,\n\tsum(total_video_view_total_time::decimal) as total_video_view_total_time\n    FROM public.smg_dmp_fb_video_dashboard_unq_view\n    where name is not null\n\tand view_date ='2022-10-12'\n\tAND created_time >= '2022-10-01'\n  AND created_time <= '2022-10-12'\n    group by 1,2\n),\nCTE_LastMonth_Start as (\n  select name, view_date,\n\tsum(total_video_view_total_time::decimal) as total_video_view_total_time\n    FROM public.smg_dmp_fb_video_dashboard_unq_view\n     where name is not null and view_date = '2022-09-01'\n\tAND created_time >= '2022-09-01'\n  AND created_time <= '2022-09-30'\n    group by 1,2\n),\nCTE_LastMonth_End as (\n    select name, view_date, sum(total_video_view_total_time::decimal) as total_video_view_total_time\n    FROM public.smg_dmp_fb_video_dashboard_unq_view\n     where name is not null and view_date = '2022-09-12'\n\tAND created_time >= '2022-09-01'\n  AND created_time <= '2022-09-30'\n    group by 1,2\n),\nCTE_LastYearMonth_Start as (\n    select name, view_date, sum(total_video_view_total_time::decimal) as total_video_view_total_time\n    FROM public.smg_dmp_fb_video_dashboard_unq_view\n   where name is not null and view_date = '2021-10-01'\n\tAND created_time >= '2021-10-01'\n  AND created_time <= '2021-10-12'\n    group by 1,2\n),\nCTE_LastYearMonth_End as (\n    select name, view_date, sum(total_video_view_total_time::decimal) as total_video_view_total_time\n    FROM public.smg_dmp_fb_video_dashboard_unq_view\n    where name is not null and view_date = '2021-10-12'\n\tAND created_time >= '2021-10-01'\n  AND created_time <= '2021-10-12'\n    group by 1,2\n)\nselect channel,cnt,\ntrunc(mtd,0) as mtd, \nconcat(trunc((mtd-mtd_lastMonth)*100/NULLIF(mtd_lastMonth,0),2),'%') as mtd_lastMonth_perc,\nconcat(trunc((mtd-mtd_lastYearMonth)*100/NULLIF(mtd_lastYearMonth,0),2),'%') as mtd_lastYear_perc\nfrom(\nselect coalesce(CTE_MTD_Start.name,CTE_MTD_End.name,CTE_LastMonth_Start.name,CTE_LastMonth_End.name,CTE_LastYearMonth_Start.name,CTE_LastYearMonth_End.name) as channel,\nCTE_MTD_End.count_site as cnt,\nSUM(coalesce(CTE_MTD_End.total_video_view_total_time,0)-coalesce(CTE_MTD_Start.total_video_view_total_time,0)) as mtd,\nSUM(coalesce(CTE_LastMonth_End.total_video_view_total_time,0)-coalesce(CTE_LastMonth_Start.total_video_view_total_time,0)) as mtd_lastMonth,\nSUM(coalesce(CTE_LastYearMonth_End.total_video_view_total_time,0)-coalesce(CTE_LastYearMonth_Start.total_video_view_total_time,0)) as mtd_lastYearMonth\nfrom CTE_MTD_Start \nFULL OUTER JOIN CTE_MTD_End on CTE_MTD_Start.name = CTE_MTD_End.name\nFULL OUTER JOIN CTE_LastMonth_Start on CTE_LastMonth_Start.name = CTE_MTD_End.name\nFULL OUTER JOIN CTE_LastMonth_End on CTE_LastMonth_End.name = CTE_LastMonth_Start.name\nFULL OUTER JOIN CTE_LastYearMonth_Start on CTE_LastYearMonth_Start.name = CTE_LastMonth_End.name\nFULL OUTER JOIN CTE_LastYearMonth_End on CTE_LastYearMonth_End.name = CTE_LastMonth_End.name\n\twhere CTE_MTD_End.count_site is not null\ngroup by 1,2 order by 1\n) as main\n\nUNION ALL\n\nselect channel,cnt,\ntrunc(mtd,0) as mtd,  \nconcat(trunc((mtd-mtd_lastMonth)*100/NULLIF(mtd_lastMonth,0),2),'%') as mtd_lastMonth_perc,\nconcat(trunc((mtd-mtd_lastYearMonth)*100/NULLIF(mtd_lastYearMonth,0),2),'%') as mtd_lastYear_perc\nfrom(\nselect 'Total' as channel,\nSUM(CTE_MTD_End.count_site) as cnt,\nSUM(coalesce(CTE_MTD_End.total_video_view_total_time,0)-coalesce(CTE_MTD_Start.total_video_view_total_time,0)) as mtd,\nSUM(coalesce(CTE_LastMonth_End.total_video_view_total_time,0)-coalesce(CTE_LastMonth_Start.total_video_view_total_time,0)) as mtd_lastMonth,\nSUM(coalesce(CTE_LastYearMonth_End.total_video_view_total_time,0)-coalesce(CTE_LastYearMonth_Start.total_video_view_total_time,0)) as mtd_lastYearMonth\nfrom CTE_MTD_Start \nFULL OUTER JOIN CTE_MTD_End on CTE_MTD_Start.name = CTE_MTD_End.name\nFULL OUTER JOIN CTE_LastMonth_Start on CTE_LastMonth_Start.name = CTE_MTD_End.name\nFULL OUTER JOIN CTE_LastMonth_End on CTE_LastMonth_End.name = CTE_LastMonth_Start.name\nFULL OUTER JOIN CTE_LastYearMonth_Start on CTE_LastYearMonth_Start.name = CTE_LastMonth_End.name\nFULL OUTER JOIN CTE_LastYearMonth_End on CTE_LastYearMonth_End.name = CTE_LastMonth_End.name\n) as total;"
    },
    "executeOnLoad": true,
    "dynamicBindingPathList": [],
    "isValid": true,
    "invalids": [],
    "messages": [],
    "jsonPathKeys": [],
    "userSetOnLoad": false,
    "confirmBeforeExecute": false,
    "policies": [],
    "userPermissions": []
  },
  "id": "Facebook_MTD_vs_new_watchhrs",
  "deleted": false,
  "gitSyncId": "62837f843cd70e097b62341a_62b98e9f4c1f4b56d4d33d82"
}